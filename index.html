<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculateur de Vol</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    .leaflet-tooltip {
      font-size: 12px;
      background: white;
      border: 1px solid #ccc;
      padding: 2px 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <h1 class="text-3xl text-center font-bold mt-4 mb-2">Calculateur de Vol</h1>

  <h2 class="text-xl text-center font-semibold mt-6 mb-2">üó∫Ô∏è Carte des a√©rodromes</h2>
  <div id="map" class="max-w-5xl mx-auto h-[400px] sm:h-[500px] rounded-xl shadow-xl border border-white"></div>

  <div class="text-center mt-3 mb-6">
    <select id="mapStyle" onchange="switchMapStyle()" class="p-2 border rounded text-sm">
      <option value="voyager">CartoDB Voyager (lisible)</option>
      <option value="stadia" selected>Stadia Alidade Smooth (d√©taill√©e)</option>
      <option value="positron">CartoDB Positron</option>
      <option value="osm">OpenStreetMap</option>
    </select>
    <button onclick="pleinEcranCarte()" class="ml-2 bg-gray-700 hover:bg-gray-800 text-white text-sm px-3 py-1 rounded">
      üóñ Plein √©cran
    </button>
    <div id="zoomLevel" class="text-sm text-gray-600 mt-2"></div>
  </div>

  <div id="result" class="text-center font-semibold text-lg mt-2 mb-4 text-blue-700"></div>

  <div class="max-w-xl mx-auto bg-white rounded-lg shadow-lg p-6 space-y-4">
    <div><label for="nom_depart" class="block font-semibold">Nom de l'a√©rodrome de d√©part :</label><input type="text" id="nom_depart" class="w-full p-2 border border-gray-300 rounded"></div>
    <div><label for="alt_a" class="block font-semibold">Altitude de d√©part (m) :</label><input type="number" id="alt_a" class="w-full p-2 border border-gray-300 rounded"></div>
    <div><label for="finesse" class="block font-semibold">Finesse du planeur :</label><input type="number" id="finesse" class="w-full p-2 border border-gray-300 rounded"></div>
    <div><label for="nom_arrivee" class="block font-semibold">Nom de l'a√©rodrome d'arriv√©e :</label><input type="text" id="nom_arrivee" class="w-full p-2 border border-gray-300 rounded"></div>
    <div><label for="alt_b" class="block font-semibold">Altitude d'arriv√©e (m) :</label><input type="number" id="alt_b" class="w-full p-2 border border-gray-300 rounded"></div>
    <div><label for="dist" class="block font-semibold">Distance (km) :</label><input type="number" id="dist" class="w-full p-2 border border-gray-300 rounded"></div>
    <div><button onclick="calculer()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 w-full rounded">Calculer</button></div>
  </div>

  <div class="max-w-4xl mx-auto mt-6 bg-white shadow-md p-4 rounded-lg"><canvas id="graphique"></canvas></div>
  <div id="tableau" class="max-w-4xl mx-auto mt-6 bg-white shadow-md p-4 rounded-lg overflow-x-auto"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    let map, baseLayer, departMarker, arriveeMarker, departCoords = null, arriveeCoords = null, vectorLine;
    let cercleLayers = [], tooltipLayers = [];

    const tileLayers = {
      voyager: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CartoDB' }),
      stadia:  L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', { attribution: '&copy; Stadia Maps', maxZoom: 20 }),
      positron: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap contributors' }),
      osm:     L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' })
    };

    function pleinEcranCarte() {
      const el = document.getElementById("map");
      if (el.requestFullscreen) el.requestFullscreen();
    }

    function switchMapStyle() {
      const style = document.getElementById("mapStyle").value;
      if (baseLayer) map.removeLayer(baseLayer);
      baseLayer = tileLayers[style];
      baseLayer.addTo(map);
    }

    function clearCircles() {
      cercleLayers.forEach(c => map.removeLayer(c));
      tooltipLayers.forEach(t => map.removeLayer(t));
      cercleLayers = [];
      tooltipLayers = [];
    }

    function addCircles(center, color, baseAlt) {
      const finesse = parseFloat(document.getElementById("finesse").value);
      if (isNaN(finesse)) return;
      for (let i = 1; i <= 5; i++) {
        const radius = i * 5000;
        const alt = baseAlt + ((radius / 1000) * 1000 / finesse) + 360;
        const circle = L.circle(center, { radius, color, dashArray: i % 2 === 0 ? "5,5" : null, fillOpacity: 0 }).addTo(map);
        cercleLayers.push(circle);
        const label = L.tooltip({ permanent: true, direction: 'right', className: "leaflet-tooltip" })
          .setLatLng(L.latLng(center.lat + radius / 111320, center.lng)).setContent(`~${Math.round(alt)} m`).addTo(map);
        tooltipLayers.push(label);
      }
    }

    function drawVector() {
      if (departCoords && arriveeCoords) {
        if (vectorLine) map.removeLayer(vectorLine);
        vectorLine = L.polyline([departCoords, arriveeCoords], { color: 'black', weight: 2, dashArray: '5,5' }).addTo(map);
      }
    }

    function calculer() {
      const alt_a = parseFloat(document.getElementById('alt_a').value);
      const alt_b = parseFloat(document.getElementById('alt_b').value);
      const finesse = parseFloat(document.getElementById('finesse').value);
      const dist = parseFloat(document.getElementById('dist').value);
      if (isNaN(alt_a) || isNaN(alt_b) || isNaN(finesse) || isNaN(dist)) return alert("Champs incomplets");

      const pt_bascul = (dist / 2) + (Math.abs(alt_a - alt_b)) * (finesse / 2000);
      const alt_bascul = (pt_bascul * 1000) / finesse + alt_a + 360;
      document.getElementById("result").innerText = `Point de bascule : ${pt_bascul.toFixed(2)} km - Altitude : ${alt_bascul.toFixed(2)} m`;

      const labels = [], altA = [], altB = [];
      for (let d = 0; d <= dist; d++) {
        labels.push(d);
        altA.push(((d * 1000) / finesse) + alt_a + 360);
        altB.push(((dist - d) * 1000 / finesse) + alt_b + 360);
      }

      const ctx = document.getElementById('graphique').getContext('2d');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [
          { label: "Altitude D√©part", data: altA, borderColor: '#3b82f6', fill: false },
          { label: "Altitude Arriv√©e", data: altB, borderColor: '#f87171', fill: false }
        ]}
      });

      let rows = "";
      for (let i = 0; i < labels.length; i += 5)
        rows += `<tr><td>${labels[i]}</td><td>${altA[i].toFixed(2)}</td><td>${altB[i].toFixed(2)}</td></tr>`;
      document.getElementById('tableau').innerHTML = `<table class="w-full text-sm text-center border"><thead><tr class="bg-blue-500 text-white"><th>Distance (km)</th><th>Altitude D√©part</th><th>Altitude Arriv√©e</th></tr></thead><tbody>${rows}</tbody></table>`;

      clearCircles();
      if (departCoords) addCircles(departCoords, "blue", alt_a);
      if (arriveeCoords) addCircles(arriveeCoords, "red", alt_b);
      drawVector();
    }

    function initMap() {
      map = L.map('map', { zoom: 6, center: [48.85, 2.35], zoomSnap: 0.25, zoomDelta: 0.25 });
      baseLayer = tileLayers["stadia"].addTo(map);
      map.zoomControl.setPosition('topright');
      map.on("zoomend", () => {
        document.getElementById("zoomLevel").innerText = "Zoom : " + map.getZoom();
      });

      L.Control.geocoder({ defaultMarkGeocode: false }).on('markgeocode', function(e) {
        const center = e.geocode.center;
        const choix = prompt("1 pour D√©part, 2 pour Arriv√©e");
        if (choix === "1") {
          if (departMarker) map.removeLayer(departMarker);
          departMarker = L.marker(center).addTo(map);
          departCoords = center;
          document.getElementById('nom_depart').value = e.geocode.name;
          document.getElementById('alt_a').value = Math.round(center.lat * 10);
        } else if (choix === "2") {
          if (arriveeMarker) map.removeLayer(arriveeMarker);
          arriveeMarker = L.marker(center).addTo(map);
          arriveeCoords = center;
          document.getElementById('nom_arrivee').value = e.geocode.name;
          document.getElementById('alt_b').value = Math.round(center.lat * 10);
        }
      }).addTo(map);
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    window.onload = initMap;
  </script>
</body>
</html>
