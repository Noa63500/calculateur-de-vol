<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculateur de Vol</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    .leaflet-tooltip {
      font-size: 12px;
      background: white;
      border: 1px solid #ccc;
      padding: 2px 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <h1 class="text-3xl text-center font-bold mt-4 mb-2">Calculateur de Vol</h1>

  <div id="map" class="max-w-5xl mx-auto h-[500px] rounded-xl shadow-xl border border-white"></div>

  <div class="max-w-xl mx-auto bg-white rounded-lg shadow-lg p-6 space-y-4 mt-6">
    <div><label class="block font-semibold">Nom de l'aérodrome de départ :</label><input type="text" id="nom_depart" class="w-full p-2 border rounded"></div>
    <div><label class="block font-semibold">Altitude de départ (m) :</label><input type="number" id="alt_a" class="w-full p-2 border rounded"></div>
    <div><label class="block font-semibold">Finesse du planeur :</label><input type="number" id="finesse" class="w-full p-2 border rounded"></div>
    <div><label class="block font-semibold">Nom de l'aérodrome d'arrivée :</label><input type="text" id="nom_arrivee" class="w-full p-2 border rounded"></div>
    <div><label class="block font-semibold">Altitude d'arrivée (m) :</label><input type="number" id="alt_b" class="w-full p-2 border rounded"></div>
    <div><label class="block font-semibold">Distance (km) :</label><input type="number" id="dist" class="w-full p-2 border rounded bg-gray-100" readonly></div>
    <div><button onclick="calculer()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 w-full rounded">Calculer</button></div>
  </div>

  <div id="result" class="text-center font-semibold text-lg mt-4 text-blue-700"></div>
  <div class="max-w-4xl mx-auto mt-6 bg-white shadow-md p-4 rounded-lg"><canvas id="graphique"></canvas></div>
  <div id="tableau" class="max-w-4xl mx-auto mt-6 bg-white shadow-md p-4 rounded-lg overflow-x-auto"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    let map, departMarker, arriveeMarker, departCoords = null, arriveeCoords = null, vectorLine;
    let cercleLayers = [], tooltipLayers = [];

    function clearCircles() {
      cercleLayers.forEach(c => map.removeLayer(c));
      tooltipLayers.forEach(t => map.removeLayer(t));
      cercleLayers = [];
      tooltipLayers = [];
    }

    function addCircles(center, color, baseAlt) {
      const finesse = parseFloat(document.getElementById("finesse").value);
      if (isNaN(finesse)) return;
      for (let i = 1; i <= 5; i++) {
        const radius = i * 5000;
        const alt = baseAlt + ((radius / 1000) * 1000 / finesse) + 360;
        const circle = L.circle(center, { radius, color, dashArray: i % 2 === 0 ? "5,5" : null, fillOpacity: 0 }).addTo(map);
        cercleLayers.push(circle);
        const label = L.tooltip({ permanent: true, direction: 'right', className: "leaflet-tooltip" })
          .setLatLng(L.latLng(center.lat + radius / 111320, center.lng)).setContent(`~${Math.round(alt)} m`).addTo(map);
        tooltipLayers.push(label);
      }
    }

    function calculerDistance() {
      if (!departCoords || !arriveeCoords) return null;
      const R = 6371;
      const dLat = (arriveeCoords.lat - departCoords.lat) * Math.PI / 180;
      const dLng = (arriveeCoords.lng - departCoords.lng) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(departCoords.lat * Math.PI / 180) *
                Math.cos(arriveeCoords.lat * Math.PI / 180) *
                Math.sin(dLng / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function drawVector() {
      if (departCoords && arriveeCoords) {
        if (vectorLine) map.removeLayer(vectorLine);
        vectorLine = L.polyline([departCoords, arriveeCoords], { color: 'black', weight: 2, dashArray: '5,5' }).addTo(map);
        const distance = calculerDistance();
        if (distance) {
          document.getElementById('dist').value = distance.toFixed(2);
        }
      }
    }

    function calculer() {
      const alt_a = parseFloat(document.getElementById('alt_a').value);
      const alt_b = parseFloat(document.getElementById('alt_b').value);
      const finesse = parseFloat(document.getElementById('finesse').value);
      const dist = parseFloat(document.getElementById('dist').value);
      if (isNaN(alt_a) || isNaN(alt_b) || isNaN(finesse) || isNaN(dist)) return alert("Champs incomplets");

      const pt_bascul = (dist / 2) + (Math.abs(alt_a - alt_b)) * (finesse / 2000);
      const alt_bascul = (pt_bascul * 1000) / finesse + alt_a + 360;
      document.getElementById("result").innerText = `Point de bascule : ${pt_bascul.toFixed(2)} km - Altitude : ${alt_bascul.toFixed(2)} m`;

      const labels = [], altA = [], altB = [];
      for (let d = 0; d <= dist; d++) {
        labels.push(d);
        altA.push(((d * 1000) / finesse) + alt_a + 360);
        altB.push(((dist - d) * 1000 / finesse) + alt_b + 360);
      }

      const ctx = document.getElementById('graphique').getContext('2d');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [
          { label: "Altitude Départ", data: altA, borderColor: '#3b82f6', fill: false },
          { label: "Altitude Arrivée", data: altB, borderColor: '#f87171', fill: false }
        ]}
      });

      let rows = "";
      for (let i = 0; i < labels.length; i += 5)
        rows += `<tr><td>${labels[i]}</td><td>${altA[i].toFixed(2)}</td><td>${altB[i].toFixed(2)}</td></tr>`;
      document.getElementById('tableau').innerHTML = `<table class="w-full text-sm text-center border"><thead><tr class="bg-blue-500 text-white"><th>Distance (km)</th><th>Altitude Départ</th><th>Altitude Arrivée</th></tr></thead><tbody>${rows}</tbody></table>`;

      clearCircles();
      if (departCoords) addCircles(departCoords, "blue", alt_a);
      if (arriveeCoords) addCircles(arriveeCoords, "red", alt_b);
      drawVector();
    }

    function initMap() {
      map = L.map('map', { zoom: 6, center: [47, 2], zoomSnap: 0.25 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      L.Control.geocoder().on('markgeocode', function(e) {
        const center = e.geocode.center;
        const choix = confirm("Voulez-vous définir ce point comme Départ ?\n\nAppuyez sur 'Annuler' pour définir comme Arrivée.");

        if (choix) setDepart(center, e.geocode.name);
        else setArrivee(center, e.geocode.name);
      }).addTo(map);

      map.on('click', function(e) {
        setDepart(e.latlng, "Point manuel");
      });

      map.on('contextmenu', function(e) {
        setArrivee(e.latlng, "Point manuel");
      });
    }

    function setDepart(latlng, name = "") {
      if (departMarker) map.removeLayer(departMarker);
      departMarker = L.marker(latlng).addTo(map);
      departCoords = latlng;
      document.getElementById('nom_depart').value = name;
      document.getElementById('alt_a').value = Math.round(latlng.lat * 10);
      clearCircles();
      addCircles(departCoords, "blue", parseFloat(document.getElementById('alt_a').value));
      drawVector();
    }

    function setArrivee(latlng, name = "") {
      if (arriveeMarker) map.removeLayer(arriveeMarker);
      arriveeMarker = L.marker(latlng).addTo(map);
      arriveeCoords = latlng;
      document.getElementById('nom_arrivee').value = name;
      document.getElementById('alt_b').value = Math.round(latlng.lat * 10);
      clearCircles();
      addCircles(arriveeCoords, "red", parseFloat(document.getElementById('alt_b').value));
      drawVector();
    }

    window.onload = initMap;
  </script>
</body>
</html>
